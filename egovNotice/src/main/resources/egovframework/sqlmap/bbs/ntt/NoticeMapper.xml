<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="NoticeDAO">

	<!-- 공지 "유효기간" 판정 (오늘 기준) -->
	<sql id="noticePeriodCondition">
		(
			(START_DATE IS NULL OR START_DATE &lt;= TO_CHAR(SYSDATE, 'YYYYMMDD'))
			AND
			(END_DATE IS NULL OR END_DATE &gt;= TO_CHAR(SYSDATE, 'YYYYMMDD'))
		)
	</sql>

	<!-- 검색 조건 -->
	<sql id="searchCondition">
		<if test="searchKeyword != null and searchKeyword != ''">
			<choose>
				<!-- 0: 제목 -->
				<when test="searchCondition == '0'">
					AND SUBJECT LIKE '%' || #{searchKeyword} || '%'
				</when>
				<!-- 1: 내용 -->
				<when test="searchCondition == '1'">
					AND CONTENT LIKE '%' || #{searchKeyword} || '%'
				</when>
				<!-- 2: 작성자 -->
				<when test="searchCondition == '2'">
					AND FRST_REGISTER_ID LIKE '%' || #{searchKeyword} || '%'
				</when>
				<!-- 기본: 제목 -->
				<otherwise>
					AND SUBJECT LIKE '%' || #{searchKeyword} || '%'
				</otherwise>
			</choose>
		</if>
	</sql>

	<!-- 기본 필터 (삭제/사용) + 게시판 -->
	<sql id="baseFilter">
		WHERE 1=1
		AND BBS_ID = #{bbsId}
		AND USE_AT = 'Y'
	</sql>


	<!-- 공지 상단 목록 NOTICE_AT='Y' 이고 기간이 유효한 것만 -->
	<select id="selectNoticePinnedList"
		parameterType="egovframework.let.bbs.ntt.vo.NoticeVO"
		resultType="egovframework.let.bbs.ntt.vo.NoticeVO">

		SELECT
			NTT_ID AS nttId,
			BBS_ID AS bbsId,
			SUBJECT AS subject,
			TO_CHAR(FRST_REGIST_PNTTM, 'YYYY-MM-DD HH24:MI:SS') AS frstRegistPnttm,
			FRST_REGISTER_ID AS frstRegisterId,
			VIEW_CNT AS viewCnt,
			PINNED_AT AS pinnedAt,
			START_DATE AS startDate,
			END_DATE AS endDate,
			ATCH_FILE_ID AS atchFileId
		FROM COMTNBBS
		<include refid="baseFilter" />
			AND PINNED_AT = 'Y'
			AND
		<include refid="noticePeriodCondition" />
		ORDER BY FRST_REGIST_PNTTM DESC, NTT_ID DESC
	</select>


	<!-- 일반 목록(페이징) - 공지(유효) 제외 (중복 방지) 
		- ROWNUM 페이징 
		- eGov PaginationInfo 기준: firstIndex: 0-based recordCountPerPage: 페이지 사이즈 
		- startRow = firstIndex + 1 
		- endRow = firstIndex + recordCountPerPage -->
	<select id="selectNoticeList"
		parameterType="egovframework.let.bbs.ntt.vo.NoticeVO"
		resultType="egovframework.let.bbs.ntt.vo.NoticeVO">

		SELECT *
		FROM (
			SELECT
				ROWNUM AS rnum,
				A.*
				FROM (
				SELECT
				NTT_ID AS nttId,
				BBS_ID AS bbsId,
				SUBJECT AS subject,
				TO_CHAR(FRST_REGIST_PNTTM, 'YYYY-MM-DD HH24:MI:SS') AS frstRegistPnttm,
				FRST_REGISTER_ID AS frstRegisterId,
				VIEW_CNT AS viewCnt,
				PINNED_AT AS pinnedAt,
				START_DATE AS startDate,
				END_DATE AS endDate,
				ATCH_FILE_ID AS atchFileId
			FROM COMTNBBS
			<include refid="baseFilter" />
				<!-- "유효 공지"는 일반 목록에서 제외 -->
				AND NOT (
				PINNED_AT = 'Y'
				AND
				<include refid="noticePeriodCondition" />
				)
				<include refid="searchCondition" />
			ORDER BY FRST_REGIST_PNTTM DESC, NTT_ID DESC
			) A
			WHERE ROWNUM &lt;= (#{firstIndex} + #{recordCountPerPage})
		)
		WHERE rnum &gt;= (#{firstIndex} + 1)

	</select>
	
	<!-- 부모 목록 페이징 -->
	<select id="selectNoticeParentList" resultType="egovframework.let.bbs.ntt.vo.NoticeVO">
	
	    SELECT *
	    FROM (
	        SELECT A.*, ROWNUM RN
	        FROM (
	            SELECT
	                n.NTT_ID,
	                n.BBS_ID,
	                n.SUBJECT,
	                n.DEL_AT,
	                n.FRST_REGIST_PNTTM,
	                n.VIEW_CNT,
	                1 AS NTT_LEVEL,
	                n.NTT_ID AS ROOT_ID,
	                n.DEL_AT AS ROOT_DEL_AT,
	                CASE
	                    WHEN EXISTS (
	                        SELECT 1
	                        FROM COMTNBBS c
	                        WHERE c.PARNT_NTT_ID = n.NTT_ID
	                          AND c.USE_AT = 'Y'
	                    )
	                    THEN 'Y'
	                    ELSE 'N'
	                END AS HAS_CHILD
	            FROM COMTNBBS n
	            WHERE n.BBS_ID = #{bbsId}
	              AND n.PARNT_NTT_ID IS NULL
	              AND n.USE_AT = 'Y'
	            ORDER BY n.NTT_ID DESC
	        ) A
	        WHERE ROWNUM 
	        <![CDATA[<=]]>
	        #{firstIndex} + #{recordCountPerPage}
	    )
	    WHERE RN > #{firstIndex}
	</select>

	
	<select id="selectNoticeParentListTotCnt" resultType="int">
		SELECT COUNT(*)
		FROM COMTNBBS
		WHERE BBS_ID = #{bbsId}
			AND PARNT_NTT_ID IS NULL
			AND USE_AT = 'Y'
	</select>
	
	<select id="selectNoticeChildTreeList" parameterType="map" resultType="egovframework.let.bbs.ntt.vo.NoticeVO">

	    SELECT
	        n.*,
	        LEVEL AS NTT_LEVEL,
	        CONNECT_BY_ROOT n.NTT_ID AS ROOT_ID,
	        CONNECT_BY_ROOT n.DEL_AT AS ROOT_DEL_AT,
	        CASE
	            WHEN EXISTS (
	                SELECT 1
	                FROM COMTNBBS c
	                WHERE c.PARNT_NTT_ID = n.NTT_ID
	                  AND c.USE_AT = 'Y'
	            )
	            THEN 'Y'
	            ELSE 'N'
	        END AS HAS_CHILD
	    FROM COMTNBBS n
	    WHERE n.BBS_ID = #{bbsId}
	      AND n.USE_AT = 'Y'
	    START WITH n.NTT_ID IN
	    <foreach collection="parentIdList" item="id" open="(" separator="," close=")">
	        #{id}
	    </foreach>
	    CONNECT BY PRIOR n.NTT_ID = n.PARNT_NTT_ID
	    ORDER SIBLINGS BY n.NTT_ID ASC
	</select>

	<!-- 일반 목록 총건수(페이징용) 
		- 공지(유효) 제외 
		- 검색조건 동일 적용 -->
	<select id="selectNoticeListTotCnt"
		parameterType="egovframework.let.bbs.ntt.vo.NoticeVO"
		resultType="int">

		SELECT COUNT(1)
		FROM COMTNBBS
		<include refid="baseFilter" />
		AND NOT (
		PINNED_AT = 'Y'
		AND
		<include refid="noticePeriodCondition" />
		)
		<include refid="searchCondition" />
	</select>
	
	<insert id="insertNotice" parameterType="egovframework.let.bbs.ntt.vo.NoticeVO">

  		INSERT INTO COMTNBBS (
		    NTT_ID,
		    BBS_ID,
		    SUBJECT,
		    CONTENT,
		    VIEW_CNT,
		    PINNED_AT,
		    START_DATE,
		    END_DATE,
		    ATCH_FILE_ID,
		    USE_AT,
		    DEL_AT,
		    FRST_REGISTER_ID,
		    FRST_REGIST_PNTTM,
		    LAST_UPDUSR_ID,
		    LAST_UPDT_PNTTM,
		    PARNT_NTT_ID
		  ) VALUES (
		    #{nttId},
		    #{bbsId},
		    #{subject},
		    #{content},
		    0,
		    #{pinnedAt},
		    #{startDate},
		    #{endDate},
		    #{atchFileId},
		    #{useAt},
		    #{delAt},
		    #{frstRegisterId},
		    SYSDATE,
		    #{frstRegisterId},
		    SYSDATE,
		    #{parntNttId}
		  )
	</insert>
	
	<!-- 상세: 삭제/미사용 제외 -->
	<select id="selectNoticeDetail"
	        parameterType="egovframework.let.bbs.ntt.vo.NoticeVO"
	        resultType="egovframework.let.bbs.ntt.vo.NoticeVO">
		SELECT
			NTT_ID AS nttId,
			BBS_ID AS bbsId,
			SUBJECT AS subject,
			CONTENT AS content,
			FRST_REGISTER_ID AS frstRegisterId,
			VIEW_CNT AS viewCnt,
			PINNED_AT AS pinnedAt,
			START_DATE AS startDate,
			END_DATE AS endDate,
			DEL_AT AS delAt,
			USE_AT AS useAt,
			ATCH_FILE_ID AS atchFileId,
			TO_CHAR(FRST_REGIST_PNTTM, 'YYYY-MM-DD HH24:MI:SS') AS frstRegistPnttm
		FROM COMTNBBS
		WHERE NTT_ID = #{nttId}
			AND USE_AT = 'Y'
	</select>
	
	<!-- 공지 트리 목록 -->
	<select id="selectNoticeTreeList" resultType="egovframework.let.bbs.ntt.vo.NoticeVO">
		SELECT
		    n.*,
		    LEVEL AS NTT_LEVEL,
		    CONNECT_BY_ROOT n.NTT_ID AS ROOT_ID,
		    CONNECT_BY_ROOT n.DEL_AT AS ROOT_DEL_AT,
		    CASE
		        WHEN EXISTS (
		            SELECT 1
		            FROM COMTNBBS c
		            WHERE c.PARNT_NTT_ID = n.NTT_ID
		        )
		        THEN 'Y'
		        ELSE 'N'
		    END AS HAS_CHILD
		FROM COMTNBBS n
		WHERE n.BBS_ID = #{bbsId}
		START WITH n.PARNT_NTT_ID IS NULL
		CONNECT BY PRIOR n.NTT_ID = n.PARNT_NTT_ID
		ORDER SIBLINGS BY n.NTT_ID DESC
	</select>

    <!-- 조회수 증가 -->
	<update id="updateInqireCo" parameterType="egovframework.let.bbs.ntt.vo.NoticeVO">
		UPDATE COMTNBBS
		SET VIEW_CNT = VIEW_CNT + 1
		WHERE NTT_ID = #{nttId}
			AND USE_AT = 'Y'
	</update>

	<!-- 소속검증: nttId로 atchFileId 조회 -->
	<select id="selectAtchFileIdByNttId" parameterType="egovframework.let.bbs.ntt.vo.NoticeVO" resultType="string">
		SELECT ATCH_FILE_ID
		FROM COMTNBBS
		WHERE NTT_ID = #{nttId}
			AND USE_AT = 'Y'
	</select>
	
	<!-- 공지 수정 -->
	<update id="updateNotice" parameterType="egovframework.let.bbs.ntt.vo.NoticeVO">
		UPDATE COMTNBBS
		  <set>
		      SUBJECT = #{subject},
		      CONTENT = #{content},
		      PINNED_AT = #{pinnedAt},
		
		      <choose>
		          <when test="startDate != null and startDate != ''">
		              START_DATE = #{startDate},
		          </when>
		          <otherwise>
		              START_DATE = NULL,
		          </otherwise>
		      </choose>
		
		      <choose>
		          <when test="endDate != null and endDate != ''">
		              END_DATE = #{endDate},
		          </when>
		          <otherwise>
		              END_DATE = NULL,
		          </otherwise>
		      </choose>
		
		      ATCH_FILE_ID = #{atchFileId}
		  </set>
		  WHERE NTT_ID = #{nttId}
		    AND BBS_ID = #{bbsId}
		    AND USE_AT = 'Y'
	</update>
	
	<!-- 공지 삭제(논리삭제) -->
	<update id="deleteNoticeList" parameterType="list">
	    UPDATE COMTNBBS
	       SET DEL_AT = 'Y'
	     WHERE NTT_ID IN
	     <foreach collection="list" item="nttId" open="(" separator="," close=")">
	         #{nttId}
	     </foreach>
	</update>
</mapper>